var Creditly=function(){var getInputValue=function(e,selector){var inputValue=$.trim($(selector).val());return inputValue+=String.fromCharCode(e.which),getNumber(inputValue)},getNumber=function(string){return string.replace(/[^\d]/g,"")},reachedMaximumLength=function(e,maximumLength,selector){return getInputValue(e,selector).length>maximumLength},isEscapedKeyStroke=function(e){return-1!==$.inArray(e.which,[46,8,9,0,27,13,190])||65==e.which&&!0===e.ctrlKey||67==e.which&&!0===e.ctrlKey||86==e.which&&!0===e.ctrlKey||e.which>=35&&e.which<=39},isNumberEvent=function(e){return/^\d+$/.test(String.fromCharCode(e.which))},onlyAllowNumeric=function(e,maximumLength,selector){return e.preventDefault(),!(reachedMaximumLength(e,maximumLength,selector)||e.shiftKey||!isNumberEvent(e))},isAmericanExpress=function(number){return number.match("^(34|37)")},shouldProcessInput=function(e,maximumLength,selector){return!isEscapedKeyStroke(e)&&onlyAllowNumeric(e,maximumLength,selector)},CvvInput={createCvvInput:function(mainSelector,creditCardNumberSelector){selector=mainSelector,numberSelector=creditCardNumberSelector;var getMaximumLength=function(isAmericanExpressCard){return isAmericanExpressCard?4:3};$(selector).keypress((function(e){$(selector).removeClass("has-error");var number=getInputValue(e,numberSelector),cvv=getInputValue(e,selector),isAmericanExpressCard=isAmericanExpress(number),maximumLength=getMaximumLength(isAmericanExpressCard);shouldProcessInput(e,maximumLength,selector)&&$(selector).val(cvv)}))}},selector,numberSelector,createCvvInput,NumberInput=function(){var selector,americanExpressSpaces=[4,10,15],defaultSpaces=[4,8,12,16],getMaximumLength=function(isAmericanExpressCard){return isAmericanExpressCard?15:16},createNumberInput=function(mainSelector){selector=mainSelector,$(selector).keypress((function(e){$(selector).removeClass("has-error");var number=getInputValue(e,selector),isAmericanExpressCard=isAmericanExpress(number),maximumLength=getMaximumLength(isAmericanExpressCard),newInput;shouldProcessInput(e,maximumLength,selector)&&(newInput=addSpaces(number,isAmericanExpressCard?americanExpressSpaces:defaultSpaces),$(selector).val(newInput),$(selector).trigger("changed_input"))}))},addSpaces=function(number,spaces){for(var parts=[],j=0,i=0;i<spaces.length;i++){if(!(number.length>spaces[i])){i<spaces.length?parts.push(number.slice(j,spaces[i])):parts.push(number.slice(j));break}parts.push(number.slice(j,spaces[i])),j=spaces[i]}return parts.length>0?parts.join(" "):number};return{createNumberInput:createNumberInput}}(),Validation=function(){var Validators=function(){var expirationRegex=/(\d\d)\s*\/\s*(\d\d)/,creditCardExpiration,isValidSecurityCode=function(isAmericanExpress,securityCode){return!!(isAmericanExpress&&4==securityCode.length||!isAmericanExpress&&3==securityCode.length)},creditCard=function(selector,data){var rawNumber=$(data.creditCardNumberSelector).val(),number=$.trim(rawNumber).replace(/\D/g,""),rawSecurityCode=$(data.cvvSelector).val(),securityCode=$.trim(rawSecurityCode).replace(/\D/g,""),messages=[],isValid=!0,selectors=[];return isValidCreditCardNumber(number)||(messages.push(data.message.number),selectors.push(data.creditCardNumberSelector),isValid=!1),isValidSecurityCode(isAmericanExpress(number),securityCode)||(messages.push(data.message.security_code),selectors.push(data.cvvSelector),isValid=!1),result={is_valid:isValid,output_value:[number,securityCode],selectors:selectors,messages:messages},result},isAmericanExpress=function(number){return 15==number.length},isValidCreditCardNumber=function(value){if(0===value.length)return!1;if(/[^0-9-\s]+/.test(value))return!1;for(var nCheck=0,nDigit=0,bEven=!1,n=value.length-1;n>=0;n--){var cDigit=value.charAt(n),nDigit=parseInt(cDigit,10);bEven&&(nDigit*=2)>9&&(nDigit-=9),nCheck+=nDigit,bEven=!bEven}return nCheck%10==0};return{creditCard:creditCard,creditCardExpiration:function(selector,data){var expirationVal=$.trim($(selector).val()),match=expirationRegex.exec(expirationVal),isValid=!1,outputValue=["",""];if(match&&3===match.length){var month=parseInt(match[1],10),year="20"+match[2];if(month>=0&&month<=12){isValid=!0;var outputValue=[month,year]}}return{is_valid:isValid,messages:[data.message],output_value:outputValue}}}}(),ValidationErrorHolder=function(){var errorMessages=[],selectors=[],addError,triggerErrorMessage;return{addError:function(selector,validatorResults){validatorResults.hasOwnProperty("selectors")?selectors=selectors.concat(validatorResults.selectors):selectors.push(selector),errorMessages.concat(validatorResults.messages)},triggerErrorMessage:function(){for(var errorsPayload={selectors:selectors,messages:errorMessages},i=0;i<selectors.length;i++)$(selectors[i]).addClass("has-error");$("body").trigger("creditly_client_validation_error",errorsPayload)}}},ValidationOutputHolder=function(){var output={},addOutput,getOutput;return{addOutput:function(outputName,value){for(var outputParts=outputName.split("."),currentPart=output,i=0;i<outputParts.length;i++)currentPart.hasOwnProperty(outputParts[i])||(currentPart[outputParts[i]]={}),i===outputParts.length-1?currentPart[outputParts[i]]=value:currentPart=currentPart[outputParts[i]]},getOutput:function(){return output}}},processSelector=function(selector,selectorValidatorMap,errorHolder,outputHolder){if(selectorValidatorMap.hasOwnProperty(selector)){var currentMapping=selectorValidatorMap[selector],validatorType=currentMapping.type,fieldName=currentMapping.name,validatorResults=Validators[validatorType](selector,currentMapping.data);if(!validatorResults.is_valid)return errorHolder.addError(selector,validatorResults),!0;if(currentMapping.output_name instanceof Array)for(var i=0;i<currentMapping.output_name.length;i++)outputHolder.addOutput(currentMapping.output_name[i],validatorResults.output_value[i]);else outputHolder.addOutput(currentMapping.output_name,validatorResults.output_value)}},validate;return{validate:function(selectorValidatorMap){var errorHolder=ValidationErrorHolder(),outputHolder=ValidationOutputHolder(),anyErrors=!1;for(var selector in selectorValidatorMap)processSelector(selector,selectorValidatorMap,errorHolder,outputHolder)&&(anyErrors=!0);return anyErrors?(errorHolder.triggerErrorMessage(),!1):outputHolder.getOutput()}}}(),ExpirationInput=function(){var maximumLength=4,selector,createExpirationInput,parseExpirationInput;return{createExpirationInput:function(mainSelector){selector=mainSelector,$(selector).keypress((function(e){if($(selector).removeClass("has-error"),shouldProcessInput(e,4,selector)){var inputValue=getInputValue(e,selector);if(inputValue.length>=2){var newInput=inputValue.slice(0,2)+" / "+inputValue.slice(2);$(selector).val(newInput)}else $(selector).val(inputValue)}}))},parseExpirationInput:function(expirationSelector){var inputValue=getNumber($(expirationSelector).val()),month=inputValue.slice(0,2),year;return{year:"20"+inputValue.slice(2),month:month}}}}(),CardTypeListener=(determineCardType=function(value){return/^(34|37)/.test(value)?"American Express":/^4/.test(value)?"Visa":/^5[0-5]/.test(value)?"MasterCard":/^(6011|622|64[4-9]|65)/.test(value)?"Discover":""},{changeCardType:function(numberSelector,cardTypeSelector){$(numberSelector).on("changed_input keypress keydown keyup",(function(e){var data=$(numberSelector).val(),cardType=determineCardType(getNumber(data));$(cardTypeSelector).text(cardType)}))}}),determineCardType,changeCardType,initialize=function(expirationSelector,creditCardNumberSelector,cvvSelector,cardTypeSelector,options){return createSelectorValidatorMap(expirationSelector,creditCardNumberSelector,cvvSelector,options),ExpirationInput.createExpirationInput(expirationSelector),NumberInput.createNumberInput(creditCardNumberSelector),CvvInput.createCvvInput(cvvSelector,creditCardNumberSelector),CardTypeListener.changeCardType(creditCardNumberSelector,cardTypeSelector),this},selectorValidatorMap,createSelectorValidatorMap=function(expirationSelector,creditCardNumberSelector,cvvSelector,options){var optionValues=options||{};optionValues.security_code_message=optionValues.security_code_message||"Your security code is invalid",optionValues.number_message=optionValues.number_message||"Your credit card number is invalid",optionValues.expiration_message=optionValues.expiration_message||"Your credit card expiration is invalid",(selectorValidatorMap={})[creditCardNumberSelector]={type:"creditCard",data:{cvvSelector:cvvSelector,creditCardNumberSelector:creditCardNumberSelector,message:{security_code:optionValues.security_code_message,number:optionValues.number_message}},output_name:["number","security_code"]},selectorValidatorMap[expirationSelector]={type:"creditCardExpiration",data:{message:optionValues.expiration_message},output_name:["expiration_month","expiration_year"]}},validate;return{initialize:initialize,validate:function(){return Validation.validate(selectorValidatorMap)}}}();